# coding=utf-8
import os
import ConfigParser
attributeSet=set([]) # 存放所有属性的集合
fileToList=[] # 用list存放每个文件的dict集合
flag=0


def getAllFiles(filepath,saveClassinfofile): # 得到目录下的文件,将文件转化为dict存到list中
    global flag
    files=os.listdir(filepath)
    for file in files:
        file=os.path.join(filepath,file)
        getclassinfo(file,saveClassinfofile)
        fi=os.listdir(file)
        for f in fi:
            filedic={}  # 代表文件的dict集合
            filedic['class']=flag  # 在dict中添加class ： flag键值对
            f=os.path.join(file,f)
            filedic=processFile(f,filedic)
            fileToList.append(filedic)
    return


def processFile(file,filedic): #将文件转为dict
    with open(file,'r') as f:
        for line in f:
            (key,value)=line.split(':')
            key=processkey(key)
            filedic[key]=value
            attributeSet.add(key)
    return filedic


def processkey(key):# 处理key的格式   ('invoke-virtual', 'goto', 'cond')
    key=str(key)
    key=key[0:len(key)-1]
    words=key.split(',')
    key=r'/'
    for word in words:
        word=word[2:len(word)-1]
        key=str(key)+word+r'/'
    return key


def getclassinfo(filepath,saveClassinfofile):#得到族和flag的对应关系，输出到文件
    global flag
    flag=flag+1
    (path,filename)=os.path.split(filepath)
    attributeSet.add('class')
    with open(saveClassinfofile,'a') as f:
        f.write(filename+':'+str(flag)+'\n')
    return


def filedicToList(filedic): # 单个文件dict的所有键值对，产生一个value的list，没有的为0
    list=[]
    for attrib in attributeSet:
        value=filedic.get(attrib)#这里的value有两种类型Nonetype和str类型
        if value==None:
            value=0
        else:
            value=int(value)
        list.append(value)
    return list


def listWriteToFile(list,saveValueFile): # 将list写入文件中
    with open(saveValueFile,'a') as f:
        text=str(list)
        f.write(text[1:len(text)-1]+'\n')
    return


def getAttributefile(saveAttributefile):#将attributeSet写入文件
    with open(saveAttributefile,'w') as f:
        print '特征属性个数为：'+str(len(attributeSet))
        for attribute in attributeSet:
            f.write('@ATTRIBUTE '+str(attribute)+' NUMERIC\n')
    return

# 配置信息
config=ConfigParser.ConfigParser()
config.read(r'init.ini')
sourcepath=config.get("Opcode","Opcodepath")
saveAttributefile=config.get("Opcode","saveAttributefile")
saveValueFile=config.get("Opcode","saveValueFile")
saveClassinfofile=config.get("Opcode","saveClassinfofile")
print "The sourcepath is "+sourcepath
print "The saveAttributefile is "+saveAttributefile
print "The saveValueFile is "+saveValueFile


getAllFiles(sourcepath,saveClassinfofile)
print '一共处理了%s个文件'%len(fileToList)
for filedict in fileToList:
    list=filedicToList(filedict)
    listWriteToFile(list,saveValueFile)
getAttributefile(saveAttributefile)
print '有%s个种类'%flag
print 'success'